/**
 * Copyright 2011 Google Inc.
 * Copyright 2014 Andreas Schildbach
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.matthewmitchell.nubitsj.core;

import com.matthewmitchell.nubitsj.params.UnitTestParams;
import com.matthewmitchell.nubitsj.script.ScriptOpCodes;
import org.junit.Before;
import org.junit.Test;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.math.BigInteger;
import java.util.Arrays;

import static com.matthewmitchell.nubitsj.core.Utils.HEX;
import static org.junit.Assert.*;

public class BlockTest {
    static final NetworkParameters params = UnitTestParams.get();

    public static final byte[] blockBytes;

    static {
        // Block a6865e19fadac8df9cc87caacaedadb1957660a7f965bd8866b8c1a27883d117
        // One with lots of transactions in, so a good test of the merkle tree hashing.
        blockBytes = HEX.decode("010000008e2ababb0ff9763e1269193f9c28118c862f2f2e8aa8cf2b97120082bec4a5125f5ea746119dc6ad5e459fa3e8ce07d0025733bdf3be5920e2ec1f61f880b93952770655e502091e00000000190100000052770655010000000000000000000000000000000000000000000000000000000000000000ffffffff0e04527706550151062f503253482fffffffff010000000000000000000000000053010000005277065501ec641bbae7a55d0b17771e9cd58a523c04a74774345f6ffce39601c0adbf088b000000006a4730440220721c221f6571f3acc27ff9ca5a775a460653dfbe1f27deb0153c728e357ef79f02203fe6d918c8a4fe14cba44b025c1700bd51bac393e60c3a28f447230cffeec2620121031c2deddc052da33584ddc31ce411afdd69a746ab8bba3d2cf04a30ecc9ce7c31ffffffff0400000000000000000080fbfb05000000002321031c2deddc052da33584ddc31ce411afdd69a746ab8bba3d2cf04a30ecc9ce7c31ac0000000000000000306a512d50c30000000142040e95062600000000000fce8e55000000000010e720be0000000000116348a20100000000000000000000000000296a522642040e76420e00000000000f848b42000000000010531a980000000000113a3b5601000000000000000053010000001d7706550175b656d08ea0c643a232c28719e8080bb337367ed14c0d138dbde608734f0cd5000000006a47304402202fdcdd9e758ca86c64f05655ddc059ffc2d0c25f11d24b617739ab4095c8192202203e543f12c522cebbc979285c4717d665652809888b3f2f6ac756691057c2fd1f0121020f06436a02260870084a2865f838e3de41ff6a7e53a861ee4d442e372412b729ffffffff02728db028000000001976a914f58e416224d05c048008c00a9f5873cf1f4a00b688acb8820100000000001976a91443f495fd4eef2a316db4ce295207958edc501f7f88ac0000000042010000001977065504565d2a10a3ed1beb5611cc2e4a87950821b0152db0ddc0c0330b83074cc58605010000006b483045022076138412d9cafac13d3077248b0159b2bd6f650c98da2f26de59f02f3c144d24022100efbcb5df45499b8bd03de54068a47c1c702ad683bb18b13bbf431dad3d405943012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff6b6b1a3d1849744ecb0dfbd08f8ee4a0d9965789149542fb5c430b80c05ea8a5010000006a4730440220793a1561abc13b0cf04452ec9effd216114818dae69c032e4e4c16d283feaa080220366b4ed4b82ac3031712d62580778934b206557b25ff9e33f610855193216b01012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffffabc6b4e6091957f4534fe5650cc4ac736b4b4b8e66a8fe55644a8de3d5d450f0010000006c493046022100cf9d2f704cdf53abb70096018ce3cd36cee83bf44aab55e96f9c978d70e801cf022100849d3a2538c2ee43684ea3d382dbd2b355b6ed42b8520c3fc6bc1c3ab0d14b32012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffffba4e6cfc5342211f4f49f6c4c50e4e5dd7569c2469a634396ad15400b2030903010000006b483045022100aac41ce07ff416ec56dd3c497ffdab1810264102f618b3251ae0dbd870717e4f022000a6821e760a72e244342b508acb9179fa9c7d5bb99d28581077bcb4a9e21a56012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff027ada6201000000001976a9145ef3fff55121ae05a872a016de0bea4b55337a8688ac22e7880a000000001976a914f0caff34efc8fcb427a2624f19f3e123e8e7b2e488ac0000000042010000001a77065502764f708ff52a23ecdd96bbb974135239eb3a3d2bf98eb0edbed3a494411864e9010000006b483045022045d769529290edcaae0d12a393a21273d1d6ceb58bf055a6079399ac90962178022100ef5854ecaffd64fad7ccf53da184577c4f8e0ce2533a87f032ae3b5a4315f987012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffffc131c666cefb2bf8480580b4bc9429045d77bdf7cc193bca27f39e730757a7c5010000006c493046022100fcf23c4eaf4db32a3870d9fbdef91b5d88887dc3dd082691b4075f662ed88333022100e282562c502b1b5a77edd23fc5b6287e173b95b3e5a7dd417d69105fe1eaaa39012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff02f162c500000000001976a914147e7900b699dc07a3d1bb916f2877db21d592fd88acab7d3005000000001976a91477b1a958672762a80db75fa54585a56922ef2a3988ac0000000042010000001b770655011ea583f0a1ac96bb2b83a423a2516e930278f96d095da056e8e7d5451ea9347b010000006b483045022100b6f530c8a31c3c883c9aaf5717b2894a53057c02673e8b1e7f66650885117be702207e675c9d809cb59239a8d8467b9123a2d15474ed5347a53383defeda3a425b04012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff0272d5f602000000001976a914ada25de80c9ab55321cd6a3ca9eab73b9aefdd5d88acaa1a0400000000001976a914c9ec540cdbc891037359faac57545639eae94bf888ac0000000042010000001c77065501453310f37ab891a1f63a3983d483a32f696b297c825ceea28e90318852f06998010000006c493046022100935e13d5c5dd20c24943060b4759351b49b391eae631c90a175898c33603ec78022100d8de0c7af0f6679ab861739cfc72d75396f029e8903785f99fafbb733d814090012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff025fdef602000000001976a914675acb6a708fc221e9621650df488b37aa50149088acbd110400000000001976a914231b367f97a597b62a0e8dae13a9265178a1a77e88ac0000000042010000001b770655011e7ac35014a273c85b5aab255983725916bf7efe587758f40daf7d24b33ab55d010000006b48304502205c628ce19488ad8051f71c1fde70c5bd3e0419318a6e452711c978219ed330f3022100e218e9b8108de075d55c2c4d08a5e59a39653ceee3f644f335f283b507c09239012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff020cc9fa02000000001976a914b67532bb5f2327d61f1bf78f625ac9394c59e2fb88ac10270000000000001976a914c2b146f1b002e4813b73296d3d47e888091c4a2988ac0000000042010000001b77065501127848c79742197c1ce9dde49476ef642aa79d787e987313bc1d166ffb3076de010000006b4830450221008f89044aca1018b871f4bb4ed95d7495ff1258374905d10d5b7b9e01e6b5047502203757c403b46c4578fe8a2dde1324a46e093671cb8d39f9a5caae8607070f03a8012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff0279cbef02000000001976a91445c85723dbf43f409a9798673801b39b25f3759b88aca3240b00000000001976a9148b070c0a237473709aaee2ea254ee1565502fa8f88ac0000000042010000001c770655016ebce9a4bfb103846f20efbe1147ea31b613e6b74f75e6fb7f1582ebea65913b010000006b483045022028fb9a2249e9143f9e693bf568fb08fddc6ce72b6d47e5bf77e05628716a56760221009c2ee7f8a7b8058914a870460e79ea353255709b17224ab268dd159659dcf6d0012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff02d47efa02000000001976a914ecf5d4c449e776eb64aa60c7d482d2595fee3de188ac48710000000000001976a91418b1f0423f7045c6b6c7f4402100efe87343f8c788ac0000000042010000001c7706550103fff8ca5cadb40419d86d3dcf48cbb98aa4b4bfccf54afc82061d3479f0247e010000006a47304402202985db8130642e7e1acdf6f3bc75e926fbff2661ec6c007d10ea427c52d4805b022016d2e2548dfaac7383981cfbe9f0ba135d7eeced72e2743fad2fce4a83898160012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff027f82f602000000001976a914c078ada2560296c55116fbe7c00499542f425fd688ac9d6d0400000000001976a914846d2f6946b6734f40c1a05e155bf8af6ed389c288ac0000000042010000001d77065501722d5f0150d8c814db8c6356af2e8e631321c0ab9a232195ce2ea19effab8210010000006b48304502201689377ca83718bf7bfc096b8c0cd6b4a787db54f0fbbb2ab0f355209a611b3f022100db36c33f1a4889afee02b286b3be84db7e2f355e75f5eebc07262e23694fb512012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff02e195df02000000001976a914bc2b7a05760cd0887e36318c2b912cf5a457b1a988ac3b5a1b00000000001976a914da9dc28267cd3dcaa1a528d63f91fda2a91aa6f888ac0000000042010000001d7706550184d0257de7c46afde9172c96c965450da4bb4f2716d29cc0af060c8bceda39b8010000006b483045022100b54f6cb1a7bdf59e309b4684755704bcfc9fe28531a130d0f9668678823044ac022009feeee58a16a987aaa101a0d9ee19fa69e535a981dc9ebc94b04fc03273d54e012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff02070af602000000001976a914b05c293077862ff0b8ca5c57f4e294634e4d698e88ac15e60400000000001976a914a56ad2835c02a8f4ea85e692f55fd1246cb0548f88ac0000000042010000001a77065501b3bea82577c555e0950040a69d8547236515bda33e53971c8a7bdaca3562b887010000006a47304402203b3d0a2aee493e9319354b5d3e73e7bf8ecc9e3837f191d2047aef89b59a545c02205ce91c7266a48cc6aa1917959671e184ce2ee5f54bfd2aa8b3e3a9cd8a26acbd012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff024062f602000000001976a914149a13340d56eecf685fbb841bc5336290ba941e88acdc8d0400000000001976a91490938a29822b61933bcdb726baf3b9f4cf19929088ac0000000042010000001a7706550158e8e6b1eeaf25ad9815a3dca8a80b6fe8ee7023daea6ca2bf316ceefbbf16b1010000006b483045022100d92be85d94cf63b01850d00498621807eca9918e0537a493370b651aa6c6b1b102205e931927de54e0efd7c47e6fb40d3e8d456256d86af6380e7206fae48322565a012103f77a49599011c1c837deb325301d74178ab08c948c55633c6d4c663c3ba1151bffffffff0204def802000000001976a9143aad557616f4340e04a14dab96bf4fad54796acf88ac18120200000000001976a91490a29f40749460ea11a82d1a98b65b918397001788ac000000004201000000197706550136d16f075108504397d42f485a6a63585f0dc4103adbe19658ba900c1e8f2a8a000000006a4730440220418ceeabc8ae994d6864306025de0aa23d8c29a54c282add7bceaf7cb1cabe79022068949ae13f8916f6be0842b6e3f54ba64ed3c1922144ea60e1081f66fb6933e1012102f76390ba920f4aa2635404012189e0d1870d11feb73ef026fb2249c2da6cf6b9ffffffff02c846f302000000001976a914a4255dc1fb3793261676ad92ca8fb5794fb74eeb88ac08a50700000000001976a914cf830e89360a06fc857198ad5fd77cff604edef388ac0000000042010000001877065501b21414a19a108539faaf493963ac33de48713d7852baedb44b9c65766ec22bc0000000006b48304502204d44120db30f70ba46a1fef6cbc18f319a686ee457ca9c20759a333c00245c8902210098af27bd9655cebeedc1a63371ee96ab6a94eca7ca88f4baa1840ec2592f7c25012102823655f317e7813ed237fdc317932aa657b5d6b08c46c496a12529acaadf0b8cffffffff029661fa02000000001976a914f93581a2de199a7230e240ee6153699686b63c0a88ac3a8a0000000000001976a914bd49773d9015fca397060871e183751847ec99d688ac00000000420100000019770655017fa4bc59068a0e4148e6987be204c2e0b616e19bf4a5d6e811f2bba1849d245d000000006b483045022100a9d78054a3c5dee40a5a92380bf96b567372deeeb8e1c9f79be89aeee626bd0e02205ed0f7aa9352b2a4ae44140c5d92b33b100e0ca44353247894480cd698ab44ae012103dfed5b511c27b56f1e505fd7d8fc553b589819dd61c1ee2926faf511ae087e4bffffffff02b0aaef00000000001976a914de7cbf44075ff27fa67e4bc30543dde81821b1de88ac20410b02000000001976a9149a0d722a22e360161b8ce33f85ba47e180185d6488ac0000000042010000001777065501ff827df23f8a4a1dcc57e6fb5e84d4b201ec1c7542eab2771c3ac588a4cb2bdb000000006a473044022077d05b945739fc40e93e4021f45ec479702e35d5402da95893916f7f50e624720220242f0eb452fc32e0aea3a2873b621377b7d8c45f5420368b0479f07048f95897012102c5f9425af874b2d280edaade49c515443bb941e3dc5b4dfc6885ac83c3ca8d52ffffffff02351d5200000000001976a914d1117917ce1eaee287947479f7d1a5e13899812888acfcad8000000000001976a9145fa1b41fce1e83140ad01f799cb4e655e8e4fb2488ac00000000420100000018770655018c1f8f11357ccbc484af0c5076139c1dc3117e6f4533f29aa465b129e3d222f0000000006b483045022100b245d32bb394df43b0d0837e5366c6ef28c6cee5e730fbb519a84374dc944cae022073bd4f1f0c24d56029df57e4f862b76a9aaf9fbc0b23cd12e693a631159bac80012103726dc10d80b4e6f2bc23bb954ffe936f87f7949dae930ddb64f27732ef7cf0fcffffffff0238f63f00000000001976a914d8a07085aa02affb8c61a98c3f5550c79d4d821b88ac903d0f00000000001976a9140f6c027c951d974532b831d5efd4829ffba1bb3188ac00000000420100000017770655017e43324fd39ff4abb3e5ca6bf7e9ae09a5004d67db92d7a9c02474d5fa9923b6000000006a473044022020cdb53c149e5b2bf267c26239d1b95350d780e54b2d7b4cabd1fac2ae68fca00220327ea3b317249ac857af7e71fdea9858d2ecff39c767f96a7617e3455c1daac8012103b4fc5b474e42447e3eb8de4a6a552494fcd4cec3c2ac3c784f057f38a95a9977ffffffff022e311700000000001976a9141f76862a8c3a78cfe03b1ad43ed798181a2a7f1d88aca9a10800000000001976a91445c6287ae41b537a1553f81beaf8b3559911a6f288ac0000000042010000001877065501e864459e064e36de42f5862dcd064bdc38964ac9b958bb9b9f8885effd983c68000000006b483045022021445cc6dfd294ef7b1d63cea556fe9a273862c191642e08a8a044283f649227022100ac025986a7ebf0c1c26b7df12eeb3472b08f6c8c5f9f5f491620d6caff1f4822012102191ad8d5764e14f0128579b019dda2343cdb50c275622e1980423274b1a3bc53ffffffff02c63f0200000000001976a914373a458e37be1975c7d69eb3c97b46238ec13a9788ac08460200000000001976a914efc8ce01ca18db2a653c052a95cf093f3138e17f88ac0000000042010000001e7706550191117b37b3fd8f256bff4f88112b41a00b3f16b37b193390c8d656331361a554000000006b4830450220769e22f1f549db86a7c65a7740e14a497f501823b42be976f0d2234ad31b2b39022100a4d3762f34884d8edcf6858bf70d48f43e17576dd8c2d378c53ac3c4b8e0ffa8012102a0c458a7436c9ac6bbfe735f7769c13e82a2f8458fdc1a80c9b4d07e6bdd158affffffff02b6070200000000001976a914ac56844c701e3474f4d2e2e140c24b90c91e62bd88acd75ac300000000001976a91408bd144008b34a0c4eaaa1d990de7bea631cc17388ac0000000042010000001e7706550175709215e3f5eafc1ececac282e6601284d3dbc87dbce851f92b724e54d52137000000006b483045022100a8e3130d66790a8e618c74a550926d8f6e180753da28fdd05cf2d9672409aa6002201552c33e2b27bf5a1df5a31cf910f9418e317ea223cd02c61c4b766953720c460121022b03cf518ae929a8c6aad830489fcf42b841126d866a5409ce9f5bfacce301e2ffffffff020aa70100000000001976a91487629ac034bfc294211938da538ee21184b3231888ac58980000000000001976a914df42cf0e8b3c540429dfff8333c5156fb2ad8b2188ac0000000042010000001e770655016ef6aaa72fc5ba7536d164d0cb5e058cdf904ecd9d0ca1cb9a382fb41ce8c55b000000006b48304502202dca1d41f6a5258bc687e79c4e0fcbafe852b599ebe9ae3cd56610817d571e4c02210093828e9e0ea92dcda8c3ec6249eeb78d13dc8ab9c6a3252b7db34a9eb6378cce012103a77511c2ed2a784e794f98a6d0974fa284bf3ec65157fe42a0fe50856d6f6c9bffffffff0237110100000000001976a9144470e4e8608ccd747f48066fd84d3f3a823fe22c88ac6f950000000000001976a9146b3887f1b745fa0ba2951faafd0c412cd4cf9b9c88ac0000000042483046022100ca7bc4ffc91f481b749cca3039010ff21a437f5bb91d87cf93c1d8269a7993e6022100e03deacff15279c8e96546e6dbc691bf8c7cb4ba58e285d023ad6a721a6f79b3");
    }

    @Before
    public void setUp() throws Exception {
        Context context = new Context(params);
    }

    @Test
    public void testWork() throws Exception {
        BigInteger work = params.getGenesisBlock().getWork();
        // This number is printed by the official client at startup as the calculated value of chainWork on testnet:
        //
        // SetBestChain: new best=00000007199508e34a9f  height=0  work=536879104
        assertEquals(BigInteger.valueOf(2L), work);
    }

    @Test
    public void testBlockVerification() throws Exception {
        Block block = new Block(params, blockBytes);
        block.verify();
        assertEquals("a6865e19fadac8df9cc87caacaedadb1957660a7f965bd8866b8c1a27883d117", block.getHashAsString());
    }
    
    @SuppressWarnings("deprecation")
    @Test
    public void testDate() throws Exception {
        Block block = new Block(params, blockBytes);
        assertEquals("16 Mar 2015 06:25:22 GMT", block.getTime().toGMTString());
    }

    @Test
    public void testBadTransactions() throws Exception {
        Block block = new Block(params, blockBytes);
        // Re-arrange so the coinbase transaction is not first.
        Transaction tx1 = block.transactions.get(0);
        Transaction tx2 = block.transactions.get(1);
        block.transactions.set(0, tx2);
        block.transactions.set(1, tx1);
        try {
            block.verify();
            fail();
        } catch (VerificationException e) {
            // We should get here.
        }
    }

    @Test
    public void testHeaderParse() throws Exception {
        Block block = new Block(params, blockBytes);
        Block header = block.cloneAsHeader();
        Block reparsed = new Block(params, header.nubitsSerialize());
        assertEquals(reparsed, header);
    }

    @Test
    public void testNuBitsSerialization() throws Exception {
        // We have to be able to reserialize everything exactly as we found it for hashing to work. This test also
        // proves that transaction serialization works, along with all its subobjects like scripts and in/outpoints.
        //
        // NB: This tests the NuBits proprietary serialization protocol. A different test checks Java serialization
        // of transactions.
        Block block = new Block(params, blockBytes);
        assertTrue(Arrays.equals(blockBytes, block.nubitsSerialize()));
    }

    @Test
    public void testJavaSerialiazation() throws Exception {
        Block block = new Block(params, blockBytes);
        Transaction tx = block.transactions.get(1);

        // Serialize using Java.
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(bos);
        oos.writeObject(tx);
        oos.close();
        byte[] javaBits = bos.toByteArray();
        // Deserialize again.
        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(javaBits));
        Transaction tx2 = (Transaction) ois.readObject();
        ois.close();

        // Note that this will actually check the transactions are equal by doing nubits serialization and checking
        // the bytestreams are the same! A true "deep equals" is not implemented for Transaction. The primary purpose
        // of this test is to ensure no errors occur during the Java serialization/deserialization process.
        assertEquals(tx, tx2);
    }
    
    @Test
    public void testUpdateLength() {
        NetworkParameters params = UnitTestParams.get();
        Block block = params.getGenesisBlock().createNextBlockWithCoinbase(new ECKey().getPubKey());
        assertEquals(block.nubitsSerialize().length, block.length);
        final int origBlockLen = block.length;
        Transaction tx = new Transaction(params);
        // this is broken until the transaction has > 1 input + output (which is required anyway...)
        //assertTrue(tx.length == tx.nubitsSerialize().length && tx.length == 8);
        byte[] outputScript = new byte[10];
        Arrays.fill(outputScript, (byte) ScriptOpCodes.OP_FALSE);
        tx.addOutput(new TransactionOutput(params, null, Coin.SATOSHI, outputScript));
        tx.addInput(new TransactionInput(params, null, new byte[] {(byte) ScriptOpCodes.OP_FALSE},
                new TransactionOutPoint(params, 0, Sha256Hash.of(new byte[] { 1 }))));
        int origTxLength = 8 + 2 + 8 + 1 + 10 + 40 + 1 + 1 + 4 + 1; // NuBits: Add 4 + 1 = time + currency byte
        assertEquals(tx.nubitsSerialize().length, tx.length);
        assertEquals(origTxLength, tx.length);
        block.addTransaction(tx);
        assertEquals(block.nubitsSerialize().length, block.length);
        assertEquals(origBlockLen + tx.length, block.length);
        block.getTransactions().get(1).getInputs().get(0).setScriptBytes(new byte[] {(byte) ScriptOpCodes.OP_FALSE, (byte) ScriptOpCodes.OP_FALSE});
        assertEquals(block.length, origBlockLen + tx.length);
        assertEquals(tx.length, origTxLength + 1);
        block.getTransactions().get(1).getInputs().get(0).setScriptBytes(new byte[] {});
        assertEquals(block.length, block.nubitsSerialize().length);
        assertEquals(block.length, origBlockLen + tx.length);
        assertEquals(tx.length, origTxLength - 1);
        block.getTransactions().get(1).addInput(new TransactionInput(params, null, new byte[] {(byte) ScriptOpCodes.OP_FALSE},
                new TransactionOutPoint(params, 0, Sha256Hash.of(new byte[] { 1 }))));
        assertEquals(block.length, origBlockLen + tx.length);
        assertEquals(tx.length, origTxLength + 41); // - 1 + 40 + 1 + 1
    }

}
